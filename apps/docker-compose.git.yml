version: "3.9"

# Stack de Git (Gitea/Forgejo). Mantida separada para ciclos independentes.
services:
  gitea:
    image: gitea/gitea:1.22
    container_name: gitea
    restart: unless-stopped
    environment:
      # Executa como usuário não root para compatibilidade com montagens persistentes
      - USER_UID=1000
      - USER_GID=1000
      # Banco embarcado (SQLite) para simplificar o bootstrap em Raspberry Pi
      - GITEA__database__DB_TYPE=sqlite3
      - GITEA__database__PATH=/data/gitea/gitea.db
      # Configuração mínima de servidor e URL raiz para Traefik
      - GITEA__server__DOMAIN=git.${HOMELAB_DOMAIN:-example.local}
      - GITEA__server__ROOT_URL=https://git.${HOMELAB_DOMAIN:-example.local}
      - GITEA__server__PROTOCOL=https
      - GITEA__server__HTTP_ADDR=0.0.0.0
      - GITEA__service__DISABLE_REGISTRATION=true
      - GITEA__security__INSTALL_LOCK=true
      - GITEA__security__SECRET_KEY=${GITEA_SECRET_KEY:-changeme}
      # Cria usuário admin padrão no primeiro start (pode ser alterado via .env)
      - GITEA_ADMIN_USER=${GITEA_ADMIN_USER:-gitea_admin}
      - GITEA_ADMIN_PASSWORD=${GITEA_ADMIN_PASSWORD:-changeme}
      - GITEA_ADMIN_EMAIL=${GITEA_ADMIN_EMAIL:-gitea_admin@example.local}
    volumes:
      - /srv/homelab/git:/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gitea.rule=Host(`git.${HOMELAB_DOMAIN}`)"
      - "traefik.http.routers.gitea.entrypoints=websecure"
      - "traefik.http.routers.gitea.tls=true"
      - "traefik.http.routers.gitea.tls.certresolver=letsencrypt"
      - "traefik.http.services.gitea.loadbalancer.server.port=3000"
    networks:
      - proxy_net
      - internal_net

networks:
  proxy_net:
    external: true
    name: ${PROXY_NETWORK}
  internal_net:
    external: true
    name: ${INTERNAL_NETWORK}
